<html>
<head>
<title>snipezzzz</title>
<script type="text/javascript">
var base_url;

function ajax_json(url, handler)
{
  var req = new XMLHttpRequest();

  alert("ajax_json: url=" + url);

  req.onreadystatechange = function()
  {
    if (req.readyState==4)
    {
      if (req.status==200)
      {
        handler(JSON.parse(req.responseText));
      } else {
	alert("Download was not successful");
      }
    }
  }
  req.open("GET", url, true);
  req.send(null);		
}

function render_screen(elements)
{
  var canvas = document.getElementById("can");
  var context = canvas.getContext("2d");

  // clear canvas
  context.fillStyle = "#000000";
  context.fillRect(0, 0, can.width, can.height);

  // render each element
  for (var i = 0; i < elements.length; i++)
  {
    var elt = elements[i];
    switch (elt.type)
    {
    case "rectangle":
      context.fillStyle = elt.color;
      context.fillRect(elt.x, elt.y, elt.width, elt.height);
      break;
    case "circle":
      context.fillStyle = elt.color;
      context.beginPath();
      context.arc(elt.x, elt.y, elt.radius, 0, Math.PI * 2, true);
      context.closePath();
      context.fill();
      break;
    case "hollow_box":
      context.strokeStyle = elt.color;
      context.rect(elt.x, elt.y, elt.width, elt.height);
      context.stroke();
      break;
    }
  }
}


var in_game = false;
var game_name;
var user_name;

function update_handler()
{
  // compute update url
  var url = base_url + "/update?user=" . urlencode(user_name);
  //...

  // Make request, with a callback that will re-invoke this
  // function.  (The server blocks if we request twice in
  // one update cycle, so this is efficient, i.e. not just busy looping)
  ajax_json(url,
            function (j) {
	      render_screen(j);
	      update_handler();
	    }
	   );
}


function do_start_new_game()
{
  var url = base_url
          + "/newgame?user="
	  + encodeURIComponent(document.getElementById("user_id_input").value)
          + "&game="
	  + encodeURIComponent(document.getElementById("game_name_input").value);
  ajax_json(url,
            function (j) {
	      render_screen(j);
	      update_handler();
	    }
	   );
}

// Code to allow the user the pick a running game,
// or start a new one.
function select_game()
{
  var container = document.getElementById("select_game");

  // delete the prior content 
  container.childNodes = [];

  // enable "Enter your user-id"
  document.getElementById("enter_user_id").style = "default"; ///XXX: what is the default style named?

  // enable "Start new game"
  document.getElementById("start_new_game").style = "default"; ///XXX: what is the default style named?

  // compute base-url here...
  base_url = "http://" + window.location.host;

  // fetch the list of active games
  ajax_json(base_url + "/games?user=" + encodeURIComponent(document.getElementById("user_id_input").value),
           function (j)
	   {
	     // handle the JSON response: create a list of active games,
	     // each of which will require an "onclick" handler.
	     //...

	     // make the selection menu visible
	     container.style = "visible";
           });
}

</script>
</head>
<body onload="select_game()" >

<h1>Snipez</h1>

<!-- will be filled up, occasionally, with a game-selection dialog -->
<p id="select_game" style="invisible">
</p>

<!-- dialog to enter the user-id, needed to join or create a game -->
<p id="enter_user_id" style="invisible">
Enter your user-id:
 <input type="text" id="user_id_input" />
</p>

<p id="start_new_game" style="invisible">
Start a new game!
 <input type="text" id="game_name_input" />
 <input type="button" id="start_new_game_link" onclick="do_start_new_game()" value="Go!" />
</p>

<!-- space for rendering the world -->
<canvas id="can" width="700" height="400" style="invisible">
  
</canvas>

</body>
</html>
